name: Daily Update
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-json:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Create assets directory
        run: mkdir -p assets

      - name: Download data
        run: |
          curl -o data_fr.html https://fr.boardgamearena.com/gamelist?isBetaStatus=
          curl -o data.html https://fr.boardgamearena.com/gamelist?allGames=

      - name: Download existing games.json
        run: |
          curl -o assets/games.json https://raw.githubusercontent.com/therealhnk/bga2myludo-web-extension/refs/heads/main/assets/games.json

      - name: Extract and process data
        run: |
          sed -n '/"game_list":\[/,/\]/p' data_fr.html | sed '1s/.*"game_list":\[//' | sed '$s/\].*//' > game_list_fr.txt
          sed -n '/"game_list":\[/,/\]/p' data.html | sed '1s/.*"game_list":\[//' | sed '$s/\].*//' > game_list_en.txt
          grep -oP ',"name":"[^"]+","display_name_en":' game_list_fr.txt | sed 's/,"name":"\([^"]*\)","display_name_en":/\1/' > names_fr.txt || true
          grep -oP ',"name":"[^"]+","display_name_en":' game_list_en.txt | sed 's/,"name":"\([^"]*\)","display_name_en":/\1/' > names_en.txt || true
          cat names_fr.txt names_en.txt | sort | uniq > merged_names.txt
          jq -Rn '[inputs | {(.): ""}] | add' merged_names.txt > transformed.json

      - name: Debug transformed.json
        run: cat transformed.json

      - name: Debug assets/games.json
        run: cat assets/games.json

      - name: Merge content into existing JSON
        run: |
          if [ -f assets/games.json ]; then
            jq -s '.[0] * (.[1] // {})' transformed.json assets/games.json > assets/merged.json
            mv assets/merged.json assets/games.json
          else
            echo "assets/games.json does not exist. Creating a new one."
            cp transformed.json assets/games.json
          fi

      - name: Debug assets/games.json after merge
        run: cat assets/games.json